% http://tex.stackexchange.com/questions/357020/latex-output-custom-commands-used-in-current-section
\documentclass{scrartcl}

\usepackage{xcolor}
\usepackage{refcount}
\usepackage{xparse}
\usepackage{tcolorbox}

%\newcommand{\speechbox}[3]{\item\leavevmode\begin{tcolorbox}[before={},after={},title=#1,colframe=#2]#3\end{tcolorbox}}
\newcommand{\speechbox}[4]{\leavevmode\begin{tcolorbox}[before={},after={},title=#1,colframe=#2,coltitle=#3]#4\end{tcolorbox}}

\ExplSyntaxOn
\seq_new:N \g_luke_listofpersons_seq
\seq_new:N \l_luke_listofpersons_seq 


\NewDocumentCommand{\addperson}{m}{%
  \seq_gput_right:Nn \g_luke_listofpersons_seq {#1}
  \seq_gremove_duplicates:N \g_luke_listofpersons_seq
}


\NewDocumentCommand{\addpersonlocal}{m}{%
  \seq_gput_right:Nn \l_luke_listofpersons_seq {#1}
}

\cs_new:Npn \IfPersonCalledAlreadyF #1#2 {%
  \seq_if_in:NnF \l_luke_listofpersons_seq {#1} {#2}
}

\NewDocumentCommand{\DisplayPersons}{}{%
  \seq_clear:N \l_luke_listofpersons_seq
  \group_begin:
  \seq_clear:N \l_tmpa_seq
  \seq_map_inline:Nn \g_luke_listofpersons_seq {%
    \IfRefUndefinedExpandable{##1\thesection}{}{
      \seq_put_right:Nn \l_tmpa_seq {\use:c{##1h}}
     }
   }
   \seq_if_empty:NF \l_tmpa_seq {
     \PrePersonList
     \seq_use:Nn \l_tmpa_seq {,~} 
     \PostPersonList
   }
   \group_end:

}
\ExplSyntaxOff

\NewDocumentCommand{\PostPersonList}{}{%
  \bigskip%

}

%\NewDocumentCommand{\displayindividualperson}{m}{%
  %\textbf{#1}%
%}

\NewDocumentCommand{\PrePersonList}{}{%
  {\large \bfseries Persons in Section \thesection}

}

%\makeatletter
%\NewDocumentCommand{\NewPerson}{m+m+m+m}{%
%  % Add this person to the global list
%  \addperson{#2}%
%  % Now define the personal \...x command 
%  \expandafter\NewDocumentCommand\csname #2x\endcsname{+m}{%
%    %Check if the person has been called in the local section already
%    \IfPersonCalledAlreadyF{#2}{%
%      \addpersonlocal{#2}
%      % Add the personal to the local list, i.e. per section
%      % Check whether the label has been defined already
%        \protected@edef\@currentlabel{\thesection.#1}\label{#1\thesection}
%    }%
%    \textsc{#1:} ##1%
%  }% End of the \...x command
%  \expandafter\NewDocumentCommand\csname #2h\endcsname{}{%
%    #2{#1}%
%  }
%}% End of \NewPerson
%\makeatother

\makeatletter
\NewDocumentCommand{\NewPerson}{m+m+m+m}{%
  % Add this person to the global list
  \addperson{#2}%
  % Now define the personal \...x command 
  \expandafter\NewDocumentCommand\csname #2x\endcsname{+m}{%
    %Check if the person has been called in the local section already
    \IfPersonCalledAlreadyF{#2}{%
      \addpersonlocal{#2}
      % Add the personal to the local list, i.e. per section
      % Check whether the label has been defined already
        \protected@edef\@currentlabel{\thesection.#2}\label{#2\thesection}
    }%
    \speechbox{#1}{#3}{#4}{##1}%
  } % defines \<charactername>x-command for speech
  \expandafter\NewDocumentCommand\csname #2h\endcsname{}{%
    \colorbox{#3}{#1}%
  } % defines \<charactername>h-command for inline highlighting
}% End of \NewPerson
\makeatother


\NewPerson{Tom}{tom}{green}{black}
\NewPerson{Frodo}{frodo}{yellow}{black}
\NewPerson{Gandalf}{gandalf}{yellow!60!blue}{white}

\begin{document}
\section{In the supermarket}
\DisplayPersons
\tomx{Hi, I'm Tom!}
\tomh

\frodox{Hi, I'm Frodo!}

\section{At TeX.SE}

\DisplayPersons

\frodox{Hi, I'm Frodo!}

\frodox{I am going to Mordor}

\gandalfx{Cast the ring into the fire!}
\gandalfh
\tomx{Waiting for Godot}
\end{document}